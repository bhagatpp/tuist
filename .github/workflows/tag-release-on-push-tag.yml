name: Tag Release

on:
  push:
    tags:
      - "*.*.*" # CLI tags like 4.49.0 (adjust if needed)

permissions:
  contents: write

env:
  MISE_HTTP_TIMEOUT: 300

jobs:
  cli-release:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup mise
        uses: jdx/mise-action@v2
        with:
          version: 2024.11.8
          experimental: true

      - name: Ensure legacy .mise symlink for tasks
        run: ln -sfn mise .mise

      - name: Build CLI bundle
        run: mise run bundle:cli

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            build/tuist.zip
            build/ProjectDescription.framework.zip
            build/ProjectAutomation.xcframework.zip
            build/SHASUMS256.txt
            build/SHASUMS512.txt
